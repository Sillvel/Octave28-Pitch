<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Octave28 Pitch Detector</title>
  <style>
    body {
      background-color: #001F3F; /* Background color */
      font-family: Arial, sans-serif;
      color: white;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    /* Centered box under the title */
    #detector {
      background-color: #3A6D8C; /* Box color */
      padding: 20px;
      margin: 0 auto;
      margin-bottom: 30px;
      max-width: 700px; /* Box width matching the title */
      border-radius: 10px; /* Rounded corners */
    }

    #log {
      font-size: 20px;
      color: white;
    }

    #noteDisplay, #solfegeDisplay {
      font-size: 28px;
      margin-top: 10px;
      color: white;
    }
  </style>
</head>
<body>

  <!-- Title -->
  <h1>Octave28 Virtual Pitch Detector</h1>

  <!-- Pitch Detector Section -->
  <div id="detector">
    <div id="log">Waiting for microphone...</div>
    <div id="noteDisplay">Note: --</div>
    <div id="solfegeDisplay">Solfège: --</div>
  </div>

  <!-- Include Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.35/Tone.js"></script>

  <!-- Include pitchdetect.js -->
  <script src="https://cdn.jsdelivr.net/gh/cwilso/PitchDetect/pitchdetect.js"></script>

  <script>
    // Note to solfege mapping
    const notes = [
      { name: 'C', solfege: 'Do' },
      { name: 'C#', solfege: 'Do#' },
      { name: 'D', solfege: 'Re' },
      { name: 'D#', solfege: 'Re#' },
      { name: 'E', solfege: 'Mi' },
      { name: 'F', solfege: 'Fa' },
      { name: 'F#', solfege: 'Fa#' },
      { name: 'G', solfege: 'Sol' },
      { name: 'G#', solfege: 'Sol#' },
      { name: 'A', solfege: 'La' },
      { name: 'A#', solfege: 'La#' },
      { name: 'B', solfege: 'Ti' }
    ];

    // Initialize the pitch detector using pitchdetect.js
    let audioContext = null;
    let pitchDetector = null;
    let isMicrophoneGranted = false;

    function errorCallback(err) {
      console.log('Error accessing microphone:', err);
      document.getElementById('log').innerText = `Error: ${err}`;
    }

    function startPitchDetection() {
      if (!isMicrophoneGranted) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            audioContext = new AudioContext();
            const mediaStreamSource = audioContext.createMediaStreamSource(stream);
            pitchDetector = PitchDetector.forMediaStream(mediaStreamSource);
            isMicrophoneGranted = true;
            document.getElementById('log').innerText = 'Microphone access granted';
            detectPitch();
          })
          .catch(errorCallback);
      }
    }

    function detectPitch() {
      pitchDetector.on('pitch', event => {
        const pitch = event.frequency;
        document.getElementById('log').innerText = `Pitch detected: ${pitch.toFixed(2)} Hz`;
        const noteData = getNoteFromFrequency(pitch);
        if (noteData) {
          document.getElementById('noteDisplay').innerText = `Note: ${noteData.name}`;
          document.getElementById('solfegeDisplay').innerText = `Solfège: ${noteData.solfege}`;
        }
      });

      pitchDetector.start();
    }

    function getNoteFromFrequency(frequency) {
      const baseFrequency = 440; // A4 = 440 Hz
      const noteIndex = Math.round(12 * Math.log2(frequency / baseFrequency)) % 12;
      if (noteIndex >= 0 && noteIndex < notes.length) {
        return notes[noteIndex];
      }
      return null;
    }

    window.onload = function() {
      startPitchDetection();
    };
  </script>
</body>
</html>
