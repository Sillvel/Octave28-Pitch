<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Detector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2d3e50;
            color: #ffffff;
            text-align: center;
            padding: 50px;
        }

        h1 {
            font-size: 2rem;
        }

        #detector {
            display: inline-block;
            padding: 20px;
            border: 3px solid #4caf50;
            border-radius: 10px;
            margin-top: 20px;
        }

        .pitch {
            font-size: 2rem;
            margin-top: 20px;
        }

        .note {
            font-size: 3rem;
            margin-top: 10px;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <h1>Pitch Detector</h1>

    <div id="detector">
        <div class="pitch">Frequency: <span id="pitch">--</span> Hz</div>
        <div class="note">Note: <span id="note">--</span></div>
    </div>

    <script>
        let audioContext = null;
        let analyser = null;
        let mediaStreamSource = null;

        const pitchElem = document.getElementById('pitch');
        const noteElem = document.getElementById('note');

        const noteStrings = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // Start pitch detection after getting audio permission
        async function startPitchDetect() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            mediaStreamSource = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            mediaStreamSource.connect(analyser);

            updatePitch();
        }

        // Update pitch and display note/frequency
        function updatePitch() {
            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            const ac = autoCorrelate(buffer, audioContext.sampleRate);
            if (ac !== -1) {
                const pitch = ac;
                pitchElem.textContent = Math.round(pitch);

                const note = noteFromPitch(pitch);
                noteElem.textContent = noteStrings[note % 12];
            }

            requestAnimationFrame(updatePitch);
        }

        // Pitch detection function
        function autoCorrelate(buffer, sampleRate) {
            let SIZE = buffer.length;
            let rms = 0;

            for (let i = 0; i < SIZE; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let r1 = 0,
                r2 = SIZE - 1;
            for (let i = 0; i < SIZE / 2; i++) {
                if (Math.abs(buffer[i]) < 0.2) {
                    r1 = i;
                    break;
                }
            }
            for (let i = 1; i < SIZE / 2; i++) {
                if (Math.abs(buffer[SIZE - i]) < 0.2) {
                    r2 = SIZE - i;
                    break;
                }
            }

            buffer = buffer.slice(r1, r2);
            SIZE = buffer.length;

            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) {
                for (let j = 0; j < SIZE - i; j++) {
                    c[i] = c[i] + buffer[j] * buffer[j + i];
                }
            }

            let d = 0;
            while (c[d] > c[d + 1]) d++;
            let maxval = -1,
                maxpos = -1;
            for (let i = d; i < SIZE; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }

            let T0 = maxpos;

            return sampleRate / T0;
        }

        function noteFromPitch(frequency) {
            const noteNumber = 12 * (Math.log(frequency / 440) / Math.log(2));
            return Math.round(noteNumber) + 69;
        }

        startPitchDetect();
    </script>
</body>
</html>
